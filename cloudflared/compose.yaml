# Docker Compose file for Cloudflared Zero Trust Tunnel
# This file sets up a Cloudflared container to run a zero trust tunnel,
# allowing secure access to services without opening ports on the firewall.
#
# References:
# - Cloudflare Tunnel Documentation: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/
# - Cloudflared GitHub: https://github.com/cloudflare/cloudflared
#
#
# # How to get started:
# 
# 1. Create a Cloudflare account and set up a Zero Trust Tunnel.
# 2. Obtain your tunnel token from the Cloudflare `Zero Trust` dashboard.
# 3. Copy env.example to .env and set CLOUDFLARED_TUNNEL_TOKEN with your tunnel token from Cloudflare.
# 4. Run: docker-compose up -d
# 5. Include the cloudflared-network in other docker-compose files to allow access to services via the tunnel.
#
#  ```yaml
#  networks:
#    cloudflared-network:
#      external: true
#  ```
#
# Version: 1.0.0
# Last Updated: 2026-01-26
# Changes: Initial setup with Cloudflared zero trust tunnel and shared network configuration

---

networks:
  default:
    name: cloudflared-network
    driver: bridge

services:
  cloudflared:
    image: cloudflare/cloudflared:${CLOUDFLARED_VERSION:-latest}
    container_name: cloudflared
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN-? "Environment variable CLOUDFLARED_TUNNEL_TOKEN must be set"}
      - TUNNEL_METRICS=127.0.0.1:49312
      - TUNNEL_TRANSPORT_PROTOCOL=http2
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:49312/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER_UPDATE_ENABLE:-false}"