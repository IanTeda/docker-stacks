# -----------------------------------------------------------------------------
# Nextcloud Docker Compose Configuration
# -----------------------------------------------------------------------------
# This docker-compose.yml file sets up a complete Nextcloud instance with:
# - Nextcloud web application (LinuxServer.io image)
# - PostgreSQL database
# - Redis cache/session store
#
# Requirements:
# - Copy .env.sample to .env and configure environment variables
# - Ensure required environment variables are set (POSTGRES_PASSWORD, etc.)
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose down           # Stop all services
#   docker-compose logs -f        # View logs
#
# Networks:
# - nextcloud-network: Internal network for service communication
# - cloudflared-network: External network for Cloudflare tunnel (if used)
#
# Volumes:
# - Data persists in ${NEXTCLOUD_PATH:-./.data}/ directories
#
# Version: 2026-02-04
# Based on: LinuxServer.io Nextcloud, PostgreSQL 15+, Redis latest
# -----------------------------------------------------------------------------

networks:
  default: # this docker-compose network
    name: nextcloud-network
    driver: bridge
  cloudflared-network:
    external: true

services:
    
  postgres:
    image: postgres:${POSTGRES_VERSION:-latest}
    container_name: nextcloud-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:? "Environment variable POSTGRES_PASSWORD must be set"}
      - POSTGRES_USER=${POSTGRES_USER:-nextcloud}
      - POSTGRES_DB=${POSTGRES_DB:-nextcloud}
    volumes:
      - ${NEXTCLOUD_PATH:-./.data}/postgres:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nextcloud}"]
      interval: 10s
      start_period: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER_UPDATE_ENABLE:-false}"

  redis:
    image: redis:${REDIS_VERSION:-latest}
    container_name: nextcloud-redis
    # Redis is used purely for caching in Nextcloud (e.g., sessions and locks), 
    # so persistence is disabled (--save "" --appendonly no) to avoid disk writes, 
    # and no volume is mounted to keep data ephemeral.
    command: redis-server --save "" --appendonly no
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER_UPDATE_ENABLE:-false}"

  nextcloud:
    image: lscr.io/linuxserver/nextcloud:${NEXTCLOUD_VERSION:-latest}
    container_name: nextcloud
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${POSTGRES_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_USER:-nextcloud}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:? "Environment variable POSTGRES_PASSWORD must be set"}
      - REDIS_HOST=redis
    volumes:
      - ${NEXTCLOUD_PATH:-./.data}/config:/config
      - ${NEXTCLOUD_PATH:-./.data}/data:/data
    ports:
      - 3443:443/tcp # Can be commented out once cloudflare up
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - cloudflared-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:443/status.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER_UPDATE_ENABLE:-false}"